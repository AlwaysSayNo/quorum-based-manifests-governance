version: "3"

env:
  CLUSTER_NAME: quorum-based-manifests-governance
  GCP_ZONE: europe-west10-a
  REPO_URL: https://github.com/AlwaysSayNo/quorum-based-manifests-governance-test.git
  REPO_NAME: quorum-based-manifests-governance-test
  REPOS_FOLDER_PATH: repos

tasks:

  init:01-init-repo:
    cmds:
      - bash init/git-test-setup.sh ${REPO_URL} ${REPO_NAME}
    desc: "Initialize the test Git repository with necessary manifests"
  
  init:02-create-argo:
    desc: "Install ArgoCD to cluster and the test application into the GKE cluster"
    cmds:
      - kubectl create namespace argocd || true
      - kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
      - kubectl wait --for=condition=ready pod --all -n argocd --timeout=300s
      - kubectl get pods -n argocd
  
  init:03-deploy-app:
    cmds:
      - kubectl create namespace test-app || true
      - kubectl apply -f ./${REPOS_FOLDER_PATH}/${REPO_NAME}/app-manifests/app.yaml
    desc: "Deploy the test application to the GKE cluster"

  init:04-clone-repo:
    cmds:
      - git clone ${REPO_URL} ./${REPOS_FOLDER_PATH}
    desc: "Clones the shared test repository to your local machine"

  dev:connect-to-cluster:
    cmds:
      - gcloud container clusters get-credentials ${CLUSTER_NAME} --zone ${GCP_ZONE}
    desc: "Connect to the GKE cluster"
  
  # Trigger ArgoCD sync button
  dev:commit-dummy-change:
    desc: "Simulates a developer pushing a change to the shared GitHub repo"
    cmds:
      - (cd ./{{.REPOS_FOLDER_PATH}}/{{.REPO_NAME}} && bash ../../commit-dummy.sh)

  dev:create-mrt:
    desc: "Create a ManifestRequestTemplate in the cluster"
    cmds:
      - (cd ./{{.REPOS_FOLDER_PATH}}/{{.REPO_NAME}} && bash ../../create-dummy-mrt.sh)

  dev:commit-all:
    desc: "Commit all changes in the local repo and push to GitHub"
    cmds:
      - | 
        (
        cd ./{{.REPOS_FOLDER_PATH}}/{{.REPO_NAME}} &&
        git pull origin main &&
        git add . &&
        git commit -m "Dev commit all changes" &&
        git push origin main
        )